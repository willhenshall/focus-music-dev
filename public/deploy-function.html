<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy sync-to-cdn Function</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
        }
        .container {
            background: #1e293b;
            border-radius: 8px;
            padding: 30px;
        }
        h1 { color: #38bdf8; margin-top: 0; }
        h2 { color: #67e8f9; margin-top: 30px; }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        .error { background: #7f1d1d; border-left: 4px solid #dc2626; }
        .success { background: #14532d; border-left: 4px solid #22c55e; }
        .info { background: #1e3a8a; border-left: 4px solid #3b82f6; }
        .warning { background: #713f12; border-left: 4px solid #f59e0b; }
        button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover { background: #0284c7; }
        button:disabled {
            background: #475569;
            cursor: not-allowed;
        }
        pre {
            background: #0f172a;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        .code-block {
            background: #0f172a;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .step {
            background: #334155;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Deploy sync-to-cdn Edge Function</h1>

        <div class="status warning">
            <strong>‚ö†Ô∏è Critical Issue:</strong> Bolt.new's automated deployment tools are broken.<br>
            This page provides alternative deployment methods.
        </div>

        <h2>Current Status</h2>
        <div id="status" class="status info">Checking function status...</div>

        <h2>Deployment Options</h2>

        <div class="step">
            <h3>Option 1: Supabase Dashboard (Recommended)</h3>
            <ol>
                <li>Go to: <a href="https://supabase.com/dashboard/project/xewajlyswijmjxuajhif/functions" target="_blank" style="color: #38bdf8;">Supabase Functions Dashboard</a></li>
                <li>Click "Create a new function" or "New Edge Function"</li>
                <li>Name: <code>sync-to-cdn</code></li>
                <li>Copy the function code below and paste it</li>
                <li>Set "Verify JWT" to <strong>OFF</strong></li>
                <li>Click "Deploy"</li>
            </ol>
            <button onclick="copyFunctionCode()">üìã Copy Function Code</button>
        </div>

        <div class="step">
            <h3>Option 2: Supabase CLI</h3>
            <p>If you have Supabase CLI installed:</p>
            <pre>supabase functions deploy sync-to-cdn --project-ref xewajlyswijmjxuajhif</pre>
        </div>

        <div class="step">
            <h3>Option 3: Contact Bolt.new Support</h3>
            <p>For the platform bug preventing automated deployment:</p>
            <ul>
                <li>Email: <a href="mailto:support@bolt.new" style="color: #38bdf8;">support@bolt.new</a></li>
                <li>Discord: <a href="https://discord.gg/bolt" target="_blank" style="color: #38bdf8;">Bolt.new Community Discord</a></li>
                <li>Twitter/X: <a href="https://twitter.com/stackblitz" target="_blank" style="color: #38bdf8;">@stackblitz</a></li>
            </ul>
            <p><strong>Bug Description:</strong> MCP Supabase tools return "A database is already setup for this project" error, preventing Edge Function deployment.</p>
        </div>

        <h2>Function Code</h2>
        <div class="code-block">
            <pre id="functionCode">Loading...</pre>
        </div>

        <h2>Test After Deployment</h2>
        <button onclick="testFunction()" id="testBtn">üß™ Test Function</button>
        <div id="testResult"></div>

        <h2>Troubleshooting</h2>
        <div class="step">
            <p><strong>If deployment fails:</strong></p>
            <ul>
                <li>Ensure you're logged into the correct Supabase project</li>
                <li>Check you have proper permissions</li>
                <li>Try the Supabase CLI method</li>
                <li>Contact Bolt.new support about the MCP bug</li>
            </ul>
        </div>
    </div>

    <script>
        const functionCode = `import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "npm:@supabase/supabase-js@2";
import { S3Client, PutObjectCommand, DeleteObjectCommand } from "npm:@aws-sdk/client-s3@3";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type, Authorization, X-Client-Info, Apikey",
};

interface SyncRequest {
  trackId: string;
  operation: 'upload' | 'delete';
}

const R2_CONFIG = {
  accountId: "531f033f1f3eb591e89baff98f027cee",
  bucketName: "focus-music-audio",
  accessKeyId: "d6c3feb94bb923b619c9661f950019d2",
  secretAccessKey: "bc5d2ea0d38fecb4ef8442b78621a6b398415b3373cc1c174b12564a111678f3",
  publicUrl: "https://pub-16f9274cf01948468de2d5af8a6fdb23.r2.dev",
  audioPath: "audio",
  metadataPath: "metadata",
};

Deno.serve(async (req: Request) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { status: 200, headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    const { trackId, operation }: SyncRequest = await req.json();

    if (!trackId) {
      return new Response(
        JSON.stringify({ error: "trackId is required" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    if (operation === 'upload') {
      const { data: trackData, error: trackError } = await supabase
        .from('audio_tracks')
        .select('file_path, metadata')
        .eq('track_id', trackId)
        .eq('deleted', false)
        .maybeSingle();

      if (trackError || !trackData) {
        return new Response(
          JSON.stringify({ error: "Track not found", details: trackError }),
          { status: 404, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }

      const fileName = trackData.file_path.split('/').pop() || '';
      const { data: fileData, error: downloadError } = await supabase.storage
        .from('audio-files')
        .download(fileName);

      if (downloadError || !fileData) {
        return new Response(
          JSON.stringify({ error: "Failed to download file", details: downloadError }),
          { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }

      const sidecarFileName = \`\${trackId}.json\`;
      const { data: sidecarData } = await supabase.storage
        .from('audio-sidecars')
        .download(sidecarFileName);

      const cdnUrl = await uploadAudioToCDN(fileName, fileData);
      let sidecarCdnUrl: string | null = null;

      if (sidecarData) {
        sidecarCdnUrl = await uploadMetadataToCDN(sidecarFileName, sidecarData);
      }

      const timestamp = new Date().toISOString();
      await supabase
        .from('audio_tracks')
        .update({
          cdn_url: cdnUrl,
          cdn_uploaded_at: timestamp,
          storage_locations: {
            supabase: true,
            r2_cdn: true,
            upload_timestamps: {
              supabase: trackData.metadata?.upload_date || timestamp,
              r2_cdn: timestamp,
            }
          }
        })
        .eq('track_id', trackId);

      return new Response(
        JSON.stringify({
          success: true,
          message: "Files synced to CDN successfully",
          cdn_url: cdnUrl,
          sidecar_cdn_url: sidecarCdnUrl,
          timestamp,
        }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );

    } else if (operation === 'delete') {
      const { data: trackData } = await supabase
        .from('audio_tracks')
        .select('cdn_url')
        .eq('track_id', trackId)
        .maybeSingle();

      if (trackData?.cdn_url) {
        const fileName = trackData.cdn_url.split('/').pop() || '';
        await deleteAudioFromCDN(fileName);
        await deleteMetadataFromCDN(\`\${trackId}.json\`);
      }

      await supabase
        .from('audio_tracks')
        .update({
          cdn_url: null,
          cdn_uploaded_at: null,
          storage_locations: {
            supabase: true,
            r2_cdn: false,
          }
        })
        .eq('track_id', trackId);

      return new Response(
        JSON.stringify({ success: true, message: "Files removed from CDN" }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    return new Response(
      JSON.stringify({ error: "Invalid operation" }),
      { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );

  } catch (error: any) {
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});

function getS3Client(): S3Client {
  return new S3Client({
    region: "auto",
    endpoint: \`https://\${R2_CONFIG.accountId}.r2.cloudflarestorage.com\`,
    credentials: {
      accessKeyId: R2_CONFIG.accessKeyId,
      secretAccessKey: R2_CONFIG.secretAccessKey,
    },
  });
}

async function uploadAudioToCDN(fileName: string, fileData: Blob): Promise<string> {
  const s3Client = getS3Client();
  const key = \`\${R2_CONFIG.audioPath}/\${fileName}\`;
  const arrayBuffer = await fileData.arrayBuffer();
  const buffer = new Uint8Array(arrayBuffer);

  await s3Client.send(new PutObjectCommand({
    Bucket: R2_CONFIG.bucketName,
    Key: key,
    Body: buffer,
    ContentType: fileData.type || 'audio/mpeg',
  }));

  return \`\${R2_CONFIG.publicUrl}/\${key}\`;
}

async function uploadMetadataToCDN(fileName: string, fileData: Blob): Promise<string> {
  const s3Client = getS3Client();
  const key = \`\${R2_CONFIG.metadataPath}/\${fileName}\`;
  const arrayBuffer = await fileData.arrayBuffer();
  const buffer = new Uint8Array(arrayBuffer);

  await s3Client.send(new PutObjectCommand({
    Bucket: R2_CONFIG.bucketName,
    Key: key,
    Body: buffer,
    ContentType: 'application/json',
  }));

  return \`\${R2_CONFIG.publicUrl}/\${key}\`;
}

async function deleteAudioFromCDN(fileName: string): Promise<void> {
  const s3Client = getS3Client();
  await s3Client.send(new DeleteObjectCommand({
    Bucket: R2_CONFIG.bucketName,
    Key: \`\${R2_CONFIG.audioPath}/\${fileName}\`,
  }));
}

async function deleteMetadataFromCDN(fileName: string): Promise<void> {
  const s3Client = getS3Client();
  await s3Client.send(new DeleteObjectCommand({
    Bucket: R2_CONFIG.bucketName,
    Key: \`\${R2_CONFIG.metadataPath}/\${fileName}\`,
  }));
}`;

        document.getElementById('functionCode').textContent = functionCode;

        async function checkStatus() {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status info';
            statusDiv.textContent = 'Checking function status...';

            try {
                const response = await fetch('https://xewajlyswijmjxuajhif.supabase.co/functions/v1/sync-to-cdn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ trackId: 'test', operation: 'upload' }),
                });

                if (response.status === 404) {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = '<strong>‚ùå Function NOT Deployed</strong><br>The sync-to-cdn function is not deployed. Please use one of the deployment options below.';
                } else {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = '<strong>‚úÖ Function Deployed!</strong><br>The sync-to-cdn function is deployed and responding. You can test it below.';
                }
            } catch (error) {
                statusDiv.className = 'status warning';
                statusDiv.innerHTML = '<strong>‚ö†Ô∏è Cannot verify status</strong><br>' + error.message;
            }
        }

        function copyFunctionCode() {
            navigator.clipboard.writeText(functionCode).then(() => {
                alert('‚úÖ Function code copied to clipboard!\n\nNow paste it in the Supabase Dashboard.');
            }).catch(err => {
                alert('‚ùå Failed to copy: ' + err.message);
            });
        }

        async function testFunction() {
            const resultDiv = document.getElementById('testResult');
            const testBtn = document.getElementById('testBtn');

            testBtn.disabled = true;
            resultDiv.className = 'status info';
            resultDiv.innerHTML = 'Testing function...';

            try {
                const response = await fetch('https://xewajlyswijmjxuajhif.supabase.co/functions/v1/sync-to-cdn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ trackId: 'test', operation: 'upload' }),
                });

                const result = await response.json();

                if (response.ok || response.status === 400 || response.status === 404) {
                    resultDiv.className = 'status success';
                    resultDiv.innerHTML = '<strong>‚úÖ Function is responding!</strong><br><pre>' + JSON.stringify(result, null, 2) + '</pre>';
                } else {
                    resultDiv.className = 'status error';
                    resultDiv.innerHTML = '<strong>‚ùå Function error:</strong><br><pre>' + JSON.stringify(result, null, 2) + '</pre>';
                }
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.innerHTML = '<strong>‚ùå Test failed:</strong><br>' + error.message;
            } finally {
                testBtn.disabled = false;
            }
        }

        checkStatus();
    </script>
</body>
</html>
