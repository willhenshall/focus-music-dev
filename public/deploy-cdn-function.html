<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deploy CDN Sync Function</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .status {
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      font-weight: 500;
    }
    .info {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #1976d2;
    }
    .success {
      background: #e8f5e9;
      color: #388e3c;
      border-left: 4px solid #4caf50;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }
    .warning {
      background: #fff3e0;
      color: #f57c00;
      border-left: 4px solid #ff9800;
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
    }
    button:hover {
      background: #1565c0;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 13px;
    }
    .code-block {
      background: #263238;
      color: #aed581;
      padding: 20px;
      border-radius: 4px;
      overflow-x: auto;
      margin: 20px 0;
    }
    .instructions {
      background: #fff9c4;
      padding: 20px;
      border-radius: 4px;
      margin: 20px 0;
      border-left: 4px solid #fbc02d;
    }
    .instructions h3 {
      margin-top: 0;
      color: #f57f17;
    }
    .instructions ol {
      padding-left: 20px;
    }
    .instructions li {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Deploy CDN Sync Edge Function</h1>
    <p>The Edge Function already exists but needs to be updated with the fixed schema code.</p>

    <div class="status info">
      <strong>Current Status:</strong> Edge Function is deployed with old code (uses 'deleted' column instead of 'deleted_at')
    </div>

    <div class="instructions">
      <h3>üìã Manual Deployment Instructions</h3>
      <p>Since the Supabase CLI requires authentication, please follow these steps to update the Edge Function:</p>

      <ol>
        <li>
          <strong>Open Supabase Dashboard:</strong><br>
          Go to: <a href="https://supabase.com/dashboard/project/xewajlyswijmjxuajhif/functions" target="_blank">
            https://supabase.com/dashboard/project/xewajlyswijmjxuajhif/functions
          </a>
        </li>

        <li>
          <strong>Find the "sync-to-cdn" function</strong><br>
          It should be in the list of existing functions
        </li>

        <li>
          <strong>Click "Edit" or "Deploy new version"</strong>
        </li>

        <li>
          <strong>Replace the code with the fixed version below</strong><br>
          Copy the entire code block and paste it into the editor
        </li>

        <li>
          <strong>Click "Deploy"</strong>
        </li>

        <li>
          <strong>Test the deployment using the button below</strong>
        </li>
      </ol>
    </div>

    <h2>üìù Fixed Edge Function Code</h2>
    <p>Copy this code and paste it into the Supabase Edge Function editor:</p>

    <div class="code-block" id="functionCode">
      <pre style="color: #aed581; margin: 0;">// File: index.ts
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "npm:@supabase/supabase-js@2";
import { S3Client, PutObjectCommand, DeleteObjectCommand } from "npm:@aws-sdk/client-s3@3";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type, Authorization, X-Client-Info, Apikey",
};

interface SyncRequest {
  trackId: string;
  operation: 'upload' | 'delete';
  filePath?: string;
  sidecarPath?: string;
}

const R2_CONFIG = {
  accountId: "531f033f1f3eb591e89baff98f027cee",
  bucketName: "focus-music-audio",
  accessKeyId: "d6c3feb94bb923b619c9661f950019d2",
  secretAccessKey: "bc5d2ea0d38fecb4ef8442b78621a6b398415b3373cc1c174b12564a111678f3",
  publicUrl: "https://pub-16f9274cf01948468de2d5af8a6fdb23.r2.dev",
  audioPath: "audio",
  metadataPath: "metadata",
};

Deno.serve(async (req: Request) => {
  if (req.method === "OPTIONS") {
    return new Response(null, {
      status: 200,
      headers: corsHeaders,
    });
  }

  try {
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    const { trackId, operation }: SyncRequest = await req.json();

    if (!trackId) {
      return new Response(
        JSON.stringify({ error: "trackId is required" }),
        {
          status: 400,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    if (operation === 'upload') {
      // ‚úÖ FIXED: Changed from .eq('deleted', false) to .is('deleted_at', null)
      const { data: trackData, error: trackError } = await supabase
        .from('audio_tracks')
        .select('file_path, metadata')
        .eq('track_id', trackId)
        .is('deleted_at', null)  // ‚Üê THIS IS THE FIX
        .maybeSingle();

      if (trackError || !trackData) {
        return new Response(
          JSON.stringify({ error: "Track not found", details: trackError }),
          {
            status: 404,
            headers: { ...corsHeaders, "Content-Type": "application/json" },
          }
        );
      }

      const filePathToSync = trackData.file_path;
      const fileName = filePathToSync.split('/').pop() || '';

      const { data: fileData, error: downloadError } = await supabase.storage
        .from('audio-files')
        .download(fileName);

      if (downloadError || !fileData) {
        return new Response(
          JSON.stringify({ error: "Failed to download file from Supabase", details: downloadError }),
          {
            status: 500,
            headers: { ...corsHeaders, "Content-Type": "application/json" },
          }
        );
      }

      const sidecarFileName = `${trackId}.json`;
      const { data: sidecarData } = await supabase.storage
        .from('audio-sidecars')
        .download(sidecarFileName);

      const cdnUrl = await uploadAudioToCDN(fileName, fileData);
      let sidecarCdnUrl: string | null = null;

      if (sidecarData) {
        sidecarCdnUrl = await uploadMetadataToCDN(sidecarFileName, sidecarData);
      }

      const timestamp = new Date().toISOString();
      const { error: updateError } = await supabase
        .from('audio_tracks')
        .update({
          cdn_url: cdnUrl,
          cdn_uploaded_at: timestamp,
          storage_locations: {
            supabase: true,
            r2_cdn: true,
            upload_timestamps: {
              supabase: trackData.metadata?.upload_date || timestamp,
              r2_cdn: timestamp,
            }
          }
        })
        .eq('track_id', trackId);

      if (updateError) {
        console.error('Failed to update database:', updateError);
      }

      return new Response(
        JSON.stringify({
          success: true,
          message: "Files synced to CDN successfully",
          cdn_url: cdnUrl,
          sidecar_cdn_url: sidecarCdnUrl,
          timestamp,
        }),
        {
          status: 200,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );

    } else if (operation === 'delete') {
      const { data: trackData } = await supabase
        .from('audio_tracks')
        .select('cdn_url, metadata')
        .eq('track_id', trackId)
        .maybeSingle();

      if (trackData?.cdn_url) {
        const fileName = trackData.cdn_url.split('/').pop() || '';
        await deleteAudioFromCDN(fileName);

        const sidecarFileName = `${trackId}.json`;
        await deleteMetadataFromCDN(sidecarFileName);
      }

      const { error: updateError } = await supabase
        .from('audio_tracks')
        .update({
          cdn_url: null,
          cdn_uploaded_at: null,
          storage_locations: {
            supabase: true,
            r2_cdn: false,
            upload_timestamps: {
              supabase: trackData?.metadata?.upload_date || new Date().toISOString(),
            }
          }
        })
        .eq('track_id', trackId);

      if (updateError) {
        console.error('Failed to update database:', updateError);
      }

      return new Response(
        JSON.stringify({
          success: true,
          message: "Files removed from CDN successfully",
        }),
        {
          status: 200,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    return new Response(
      JSON.stringify({ error: "Invalid operation" }),
      {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );

  } catch (error: any) {
    console.error('CDN sync error:', error);
    return new Response(
      JSON.stringify({ error: error.message || "Internal server error", stack: error.stack }),
      {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );
  }
});

function getS3Client(): S3Client {
  return new S3Client({
    region: "auto",
    endpoint: `https://${R2_CONFIG.accountId}.r2.cloudflarestorage.com`,
    credentials: {
      accessKeyId: R2_CONFIG.accessKeyId,
      secretAccessKey: R2_CONFIG.secretAccessKey,
    },
  });
}

async function uploadAudioToCDN(fileName: string, fileData: Blob): Promise<string> {
  const s3Client = getS3Client();
  const key = `${R2_CONFIG.audioPath}/${fileName}`;

  const arrayBuffer = await fileData.arrayBuffer();
  const buffer = new Uint8Array(arrayBuffer);

  const command = new PutObjectCommand({
    Bucket: R2_CONFIG.bucketName,
    Key: key,
    Body: buffer,
    ContentType: fileData.type || 'audio/mpeg',
  });

  await s3Client.send(command);

  const cdnUrl = `${R2_CONFIG.publicUrl}/${key}`;
  console.log(`Uploaded audio to CDN: ${cdnUrl}`);

  return cdnUrl;
}

async function uploadMetadataToCDN(fileName: string, fileData: Blob): Promise<string> {
  const s3Client = getS3Client();
  const key = `${R2_CONFIG.metadataPath}/${fileName}`;

  const arrayBuffer = await fileData.arrayBuffer();
  const buffer = new Uint8Array(arrayBuffer);

  const command = new PutObjectCommand({
    Bucket: R2_CONFIG.bucketName,
    Key: key,
    Body: buffer,
    ContentType: 'application/json',
  });

  await s3Client.send(command);

  const cdnUrl = `${R2_CONFIG.publicUrl}/${key}`;
  console.log(`Uploaded metadata to CDN: ${cdnUrl}`);

  return cdnUrl;
}

async function deleteAudioFromCDN(fileName: string): Promise<void> {
  const s3Client = getS3Client();
  const key = `${R2_CONFIG.audioPath}/${fileName}`;

  const command = new DeleteObjectCommand({
    Bucket: R2_CONFIG.bucketName,
    Key: key,
  });

  await s3Client.send(command);
  console.log(`Deleted audio from CDN: ${key}`);
}

async function deleteMetadataFromCDN(fileName: string): Promise<void> {
  const s3Client = getS3Client();
  const key = `${R2_CONFIG.metadataPath}/${fileName}`;

  const command = new DeleteObjectCommand({
    Bucket: R2_CONFIG.bucketName,
    Key: key,
  });

  await s3Client.send(command);
  console.log(`Deleted metadata from CDN: ${key}`);
}</pre>
    </div>

    <button onclick="copyCode()" style="background: #388e3c;">
      üìã Copy Code to Clipboard
    </button>

    <button onclick="window.open('https://supabase.com/dashboard/project/xewajlyswijmjxuajhif/functions', '_blank')">
      üîó Open Supabase Dashboard
    </button>

    <hr style="margin: 40px 0;">

    <h2>üß™ Test Deployment</h2>
    <p>After updating the function, test it here:</p>

    <button onclick="testFunction()" id="testBtn">
      üß™ Test Edge Function
    </button>

    <div id="testResult"></div>

  </div>

  <script>
    function copyCode() {
      const code = document.getElementById('functionCode').innerText;
      navigator.clipboard.writeText(code).then(() => {
        alert('‚úÖ Code copied to clipboard!\\n\\nNow:\\n1. Open the Supabase Dashboard\\n2. Go to Edge Functions\\n3. Edit sync-to-cdn\\n4. Paste the code\\n5. Deploy');
      });
    }

    async function testFunction() {
      const btn = document.getElementById('testBtn');
      const resultDiv = document.getElementById('testResult');

      btn.disabled = true;
      btn.textContent = 'Testing...';
      resultDiv.innerHTML = '<div class="status info">Testing Edge Function...</div>';

      try {
        const response = await fetch(
          'https://xewajlyswijmjxuajhif.supabase.co/functions/v1/sync-to-cdn',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              trackId: '999999',
              operation: 'upload'
            })
          }
        );

        const data = await response.json();

        if (data.error && data.error.includes('deleted does not exist')) {
          resultDiv.innerHTML = `
            <div class="status error">
              <strong>‚ùå Function NOT Updated Yet</strong><br>
              Still using old code with 'deleted' column.<br><br>
              <strong>Action Required:</strong> Please update the function in the Supabase Dashboard with the fixed code above.
            </div>
          `;
        } else if (data.error === 'Track not found' && !data.details) {
          resultDiv.innerHTML = `
            <div class="status success">
              <strong>‚úÖ Function Updated Successfully!</strong><br>
              The Edge Function is now using the fixed schema code.<br><br>
              Error "Track not found" is expected (track 999999 doesn't exist).<br>
              The function is working correctly!
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="status warning">
              <strong>‚ö†Ô∏è Unexpected Response</strong><br>
              Response: <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="status error">
            <strong>‚ùå Test Failed</strong><br>
            Error: ${error.message}
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üß™ Test Edge Function';
      }
    }
  </script>
</body>
</html>
