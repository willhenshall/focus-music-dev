<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Install exec_ddl + Fix Quiz - One Click</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1a202c;
      margin-bottom: 10px;
    }
    .step {
      background: #f0f9ff;
      border-left: 4px solid #0284c7;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .step h2 {
      margin-top: 0;
      color: #0284c7;
      font-size: 20px;
    }
    .sql-box {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 20px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 15px 0;
      max-height: 400px;
    }
    .sql-box pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
    }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background 0.2s;
      margin: 5px;
    }
    button:hover {
      background: #1976d2;
    }
    .success {
      background: #4caf50;
      color: white;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      display: none;
    }
    .warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
    }
    ol {
      margin: 10px 0;
      padding-left: 20px;
    }
    li {
      margin: 8px 0;
    }
    code {
      background: #e0e0e0;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ One-Time Setup: Install exec_ddl Function</h1>

    <div class="warning">
      <strong>â±ï¸ This is a ONE-TIME setup that takes 30 seconds</strong><br>
      After this, ALL future database fixes will be automatic - no more manual SQL!
    </div>

    <div class="step">
      <h2>Step 1: Copy the SQL</h2>
      <p>Click the button below to copy the combined SQL (installs function + fixes quiz):</p>
      <button onclick="copyCombinedSQL()">ğŸ“‹ Copy Complete SQL</button>
      <div id="successMsg1" class="success">âœ… SQL copied!</div>
    </div>

    <div class="step">
      <h2>Step 2: Run in Supabase</h2>
      <ol>
        <li>Go to <a href="https://supabase.com/dashboard/project/xewajlyswijmjxuajhif/sql/new" target="_blank" style="color: #2196f3; font-weight: 600;">Supabase SQL Editor</a></li>
        <li>Paste the SQL (Ctrl+V or Cmd+V)</li>
        <li>Click the "Run" button</li>
        <li>Look for "SUCCESS" message</li>
      </ol>
    </div>

    <div class="step">
      <h2>Step 3: Done!</h2>
      <p>âœ… The <code>exec_ddl</code> function is now installed<br>
      âœ… The <code>quiz_responses</code> table is fixed<br>
      âœ… All future database fixes will be automatic!</p>
    </div>

    <hr style="margin: 30px 0;">

    <details>
      <summary style="cursor: pointer; font-weight: 600; font-size: 16px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
        ğŸ“– View SQL Code (optional)
      </summary>
      <div class="sql-box">
        <pre id="combinedSQL">-- ========================================================================
-- ONE-TIME SETUP: Install exec_ddl function + Fix Quiz
-- ========================================================================

-- STEP 1: Install the exec_ddl function for future automation
CREATE OR REPLACE FUNCTION public.exec_ddl(ddl_statement text)
RETURNS text
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  EXECUTE ddl_statement;
  RETURN 'SUCCESS';
EXCEPTION
  WHEN OTHERS THEN
    RETURN 'ERROR: ' || SQLERRM;
END;
$$;

-- Grant permissions
GRANT EXECUTE ON FUNCTION public.exec_ddl(text) TO service_role;
GRANT EXECUTE ON FUNCTION public.exec_ddl(text) TO authenticated;

COMMENT ON FUNCTION public.exec_ddl(text) IS
  'Executes DDL statements for automated schema management.';

-- STEP 2: Fix the quiz_responses table immediately
CREATE TABLE IF NOT EXISTS quiz_responses (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  question_number integer NOT NULL CHECK (question_number BETWEEN 1 AND 21),
  response_value integer NOT NULL,
  response_time_ms integer,
  created_at timestamptz DEFAULT now()
);

ALTER TABLE quiz_responses ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can insert own quiz responses" ON quiz_responses;
DROP POLICY IF EXISTS "Users can view own quiz responses" ON quiz_responses;

CREATE POLICY "Users can insert own quiz responses"
  ON quiz_responses FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can view own quiz responses"
  ON quiz_responses FOR SELECT
  TO authenticated
  USING (auth.uid() = user_id);

CREATE INDEX IF NOT EXISTS idx_quiz_responses_user_id ON quiz_responses(user_id);
CREATE INDEX IF NOT EXISTS idx_quiz_responses_created_at ON quiz_responses(created_at DESC);

-- ========================================================================
-- VERIFICATION
-- ========================================================================
DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—';
  RAISE NOTICE 'â•‘  âœ… SUCCESS! Installation Complete                    â•‘';
  RAISE NOTICE 'â•‘                                                       â•‘';
  RAISE NOTICE 'â•‘  1. exec_ddl function installed âœ…                    â•‘';
  RAISE NOTICE 'â•‘  2. quiz_responses table fixed âœ…                     â•‘';
  RAISE NOTICE 'â•‘  3. Future fixes will be automatic âœ…                 â•‘';
  RAISE NOTICE 'â•‘                                                       â•‘';
  RAISE NOTICE 'â•‘  You can now close this window and test the quiz!    â•‘';
  RAISE NOTICE 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
  RAISE NOTICE '';
END $$;</pre>
      </div>
    </details>

  </div>

  <script>
    function copyCombinedSQL() {
      const sqlCode = document.getElementById('combinedSQL').textContent;
      navigator.clipboard.writeText(sqlCode).then(() => {
        const successMsg = document.getElementById('successMsg1');
        successMsg.style.display = 'block';
        setTimeout(() => {
          successMsg.style.display = 'none';
        }, 3000);
      }).catch(err => {
        alert('Failed to copy. Please select and copy manually.');
      });
    }
  </script>
</body>
</html>
