# Performance Instrumentation

This directory contains tools for measuring and proving audio playback performance.

## TTFA (Time To First Audible)

TTFA measures the time from user action (click channel/energy) to first audible audio playing.

### Key Files

- `src/lib/playerPerf.ts` - Runtime instrumentation API
- `test/e2e/ttfa-metrics.spec.ts` - E2E test that captures TTFA metrics
- `perf/ttfa-report.cjs` - CLI script to analyze TTFA data
- `perf/ttfa-latest.json` - Latest TTFA data (generated by E2E tests)

### How It Works

1. **Instrumentation Hooks**: `playerPerf.ts` provides a structured API:
   - `perfStart()` - Called when user initiates playback
   - `perfMark()` - Called at key points (playlistReady, trackLoadStart, sourceSelected, manifestParsed, firstAudio)
   - `perfSuccess()` - Called when first audible audio is detected
   - `perfFail()` - Called if loading times out

2. **Runtime Storage**: Events are stored in an in-memory ring buffer (last 200 events).

3. **Dev Access**: In dev mode, access via:
   ```javascript
   window.__playerPerf.events()   // Get all events
   window.__playerPerf.summary()  // Get p50/p95/max stats
   window.__playerPerf.clear()    // Clear events
   window.__playerPerf.latest()   // Get most recent event
   ```

4. **Console Logging**: On success/failure, a single structured line is logged:
   ```
   [TTFA] {"requestId":"...","ttfaMs":1234,"success":true,...}
   ```

### Running Tests

```bash
# Run the TTFA E2E test
npx playwright test ttfa-metrics.spec.ts

# Run with headed browser (for debugging)
npx playwright test ttfa-metrics.spec.ts --headed

# Run and generate report
npx playwright test ttfa-metrics.spec.ts && npm run ttfa:report
```

### Generating Reports

```bash
# Analyze the latest TTFA data
npm run ttfa:report

# Analyze a specific file
node perf/ttfa-report.cjs path/to/events.json
```

### Example Output

```
╔══════════════════════════════════════════════════════════════╗
║                    TTFA Performance Report                    ║
╚══════════════════════════════════════════════════════════════╝

Overview:
  Total Events:     5
  Successes:        5
  Failures:         0
  Success Rate:     100%

Timing Statistics:
  Min:              1234ms
  Mean:             1567ms
  P50 (median):     1456ms
  P95:              2345ms
  Max:              2567ms

Distribution:
  P50                  ██████████░░░░░░░░░░░░░░░░░░░░ 1456ms
  P95                  ████████████████░░░░░░░░░░░░░░ 2345ms
  Max                  ███████████████████░░░░░░░░░░░ 2567ms
  ────────────────────────────────────────────────── 8000ms threshold

By Trigger Type:
  channel_change     count: 3, p50: 1500ms
  energy_change      count: 2, p50: 1400ms

Verdict:
  ✓ Excellent performance (P95 ≤ 4s)
```

### TTFAEvent Structure

```typescript
interface TTFAEvent {
  // Required
  requestId: string;              // Unique ID for this load attempt
  triggerType: 'channel_change' | 'energy_change' | 'play' | 'resume';
  clickAt: number;                // performance.now() timestamp

  // Context
  channelId?: string;
  channelName?: string;
  energyLevel?: string;

  // Timing marks
  playlistReadyAt?: number;       // When first track is available
  trackLoadStartAt?: number;      // Before audioEngine.loadTrack()
  sourceSelectedAt?: number;      // When HLS vs MP3 is decided
  manifestParsedAt?: number;      // When HLS manifest is parsed
  firstAudioAt?: number;          // When first audible audio plays

  // Result
  ttfaMs?: number;                // Total time from click to audio
  audioType?: 'hls' | 'mp3';
  success?: boolean;
  error?: string;                 // Error message if failed
}
```

### Manual Verification

1. Run dev server: `npm run dev`
2. Open app in browser
3. Open console, click a channel
4. See `[TTFA]` log line with timing data
5. Pause → change energy → see another `[TTFA]` log line
6. Run `window.__playerPerf.summary()` for stats

---

## Playback Network Trace

Network trace instrumentation that captures all HTTP requests during playback startup.

### Key Files

- `src/lib/playbackNetworkTrace.ts` - Runtime instrumentation API
- `test/e2e/playback-network-trace.spec.ts` - E2E test for trace system
- `perf/playback-trace-report.cjs` - CLI script to analyze trace data

### How It Works

1. **Automatic Capture**: All fetch requests are captured during active traces
2. **Structured Output**: After each trace, a human-readable summary is logged to console
3. **Dev Access**: In dev mode, access via:
   ```javascript
   window.__playbackTrace.latest()         // Get most recent trace
   window.__playbackTrace.traces()         // Get all completed traces
   window.__playbackTrace.warnings()       // Get heuristic warnings for latest trace
   window.__playbackTrace.downloadLatest() // Download latest trace as JSON file
   window.__playbackTrace.downloadAll()    // Download all traces as JSON file
   window.__playbackTrace.printSummary()   // Print human-readable summary to console
   window.__playbackTrace.clear()          // Clear all traces
   ```

### Console Output

After each playback attempt, you'll see two log entries:

1. **Raw JSON** (`[PLAYBACK_TRACE]`): Machine-readable data for parsing
2. **Human Summary** (`[PLAYBACK_TRACE_SUMMARY]`): 5-15 line formatted report:

```
╭──────────────────────────────────────────────────────────────╮
│ PLAYBACK TRACE SUMMARY                                       │
├──────────────────────────────────────────────────────────────┤
│ ✅ SUCCESS  TTFA: 1234ms     requestId: abc12345...
│ Trigger: channel_change   Channel: Focus Flow
│ Energy: high              Engine: streaming
├──────────────────────────────────────────────────────────────┤
│ Network: 15 requests, 850ms total
│   api.supabase.co                    8 reqs     450ms
│   r2.cloudflarestorage.com           7 reqs     400ms
├──────────────────────────────────────────────────────────────┤
│ Slowest Requests:
│   GET  /rest/v1/audio_tracks                         180ms
│   GET  /rest/v1/slot_strategies                      120ms
├──────────────────────────────────────────────────────────────┤
│ ⚠️  Warnings (1):
│   ⚠️ Multiple user_preferences calls (2x) - consider caching
╰──────────────────────────────────────────────────────────────╯
```

### Exporting Trace Data

**One-click browser export:**
```javascript
window.__playbackTrace.downloadLatest()  // Downloads playback-trace-<timestamp>.json
window.__playbackTrace.downloadAll()     // Downloads playback-traces-all-<timestamp>.json
```

### Generating CLI Reports

```bash
# Move downloaded file to perf directory first
mv ~/Downloads/playback-trace-*.json perf/playback-trace-latest.json

# Generate report
npm run playback:report

# Or analyze a specific file
node perf/playback-trace-report.cjs path/to/trace.json
```

### Heuristic Warnings

The trace system automatically detects common performance issues:

| Warning Type | Description |
|-------------|-------------|
| `duplicate_user_preferences` | Multiple user_preferences calls (should be cached) |
| `audio_tracks_select_all` | Using `select=*` on audio_tracks (fetch only needed columns) |
| `analytics_before_audio` | Analytics calls blocking fast start |
| `duplicate_slot_strategy` | Multiple slot_strategies fetches |

### Manual Verification Workflow

1. Run `npm run dev`
2. Click a channel to start playback
3. See `[PLAYBACK_TRACE_SUMMARY]` in console
4. Run `window.__playbackTrace.downloadLatest()` in console
5. Move downloaded file: `mv ~/Downloads/playback-trace-*.json perf/playback-trace-latest.json`
6. Run `npm run playback:report`

